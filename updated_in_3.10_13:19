import time
import json
import os
import threading
import sys
import tkinter as tk
from tkinter import simpledialog, messagebox, Listbox, MULTIPLE
from pynput import mouse, keyboard

# ğŸ“‚ í˜„ì¬ ì‹¤í–‰ íŒŒì¼ì˜ ê²½ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì €ì¥ í´ë” ì„¤ì • (PyInstaller ì‹¤í–‰ ëŒ€ì‘)
if getattr(sys, 'frozen', False):
    BASE_DIR = os.path.dirname(sys.executable)  # .exe íŒŒì¼ì´ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬
else:
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))  # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ìœ„ì¹˜

SAVE_DIR = os.path.join(BASE_DIR, "macro_files")
os.makedirs(SAVE_DIR, exist_ok=True)  # í´ë” ì—†ìœ¼ë©´ ìë™ ìƒì„±

class MacroRecorder:
    def __init__(self, root):
        self.root = root
        self.root.title("ë§ˆìš°ìŠ¤ ë§¤í¬ë¡œ í”„ë¡œê·¸ë¨")
        
        self.recording = False
        self.replaying = False
        self.data = []
        self.start_time = None
        self.speed = 1.0

        # UI êµ¬ì„±
        self.record_button = tk.Button(root, text="ğŸ”´ ë…¹í™” ì‹œì‘", command=self.start_recording)
        self.record_button.pack(pady=5)
        
        self.play_button = tk.Button(root, text="â–¶ ì‹¤í–‰", command=self.open_macro_selection)
        self.play_button.pack(pady=5)
        
        self.file_listbox = Listbox(root, height=10)
        self.file_listbox.pack(pady=5)
        self.update_file_list()
        
        self.delete_button = tk.Button(root, text="ğŸ—‘ ì‚­ì œ", command=self.delete_selected_macro)
        self.delete_button.pack(pady=5)

        # í‚¤ë³´ë“œ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ (ì—”í„° í‚¤ ê°ì§€)
        self.listener = keyboard.Listener(on_press=self.on_key_press)
        self.listener.start()

    def update_file_list(self):
        """ ì €ì¥ëœ ë§¤í¬ë¡œ ëª©ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ """
        self.file_listbox.delete(0, tk.END)
        for file in os.listdir(SAVE_DIR):
            if file.endswith(".json"):
                self.file_listbox.insert(tk.END, file.replace(".json", ""))
    
    def delete_selected_macro(self):
        """ ì„ íƒëœ íŒŒì¼ ì‚­ì œ """
        selection = self.file_listbox.curselection()
        if not selection:
            messagebox.showwarning("ê²½ê³ ", "ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.")
            return
        
        for index in selection[::-1]:
            filename = self.file_listbox.get(index)
            file_path = os.path.join(SAVE_DIR, f"{filename}.json")

            if os.path.exists(file_path):
                os.remove(file_path)

        self.update_file_list()
        messagebox.showinfo("ì‚­ì œ ì™„ë£Œ", "ì„ íƒí•œ ë§¤í¬ë¡œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")

    def start_recording(self):
        """ ë…¹í™” ì‹œì‘ (ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”) """
        if self.recording:
            return
        self.recording = True
        self.data = []  # ğŸ”¥ ë…¹í™” ì‹œì‘ ì‹œ ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
        self.start_time = None
        
        self.record_button.config(text="âº ë…¹í™” ì¤‘", state=tk.DISABLED)
        self.play_button.config(state=tk.DISABLED)

        def countdown():
            for i in range(3, 0, -1):
                self.record_button.config(text=f"â³ {i}ì´ˆ í›„ ì‹œì‘...")
                time.sleep(1)
            self.record_button.config(text="âº ë…¹í™” ì¤‘")
            self.start_time = time.time()
            self.mouse_listener = mouse.Listener(on_click=self.on_click, on_move=self.on_move)
            self.mouse_listener.start()
        
        threading.Thread(target=countdown, daemon=True).start()

    def stop_recording(self):
        """ ë…¹í™” ì¤‘ì§€ ë° íŒŒì¼ ì €ì¥ """
        if not self.recording:
            return
        self.recording = False

        self.record_button.config(text="ğŸ”´ ë…¹í™” ì‹œì‘", state=tk.NORMAL)
        self.play_button.config(state=tk.NORMAL)

        if hasattr(self, "mouse_listener"):
            self.mouse_listener.stop()
        
        # ğŸ”¥ ë…¹í™”ëœ ë°ì´í„° í™•ì¸
        print(f"ğŸ”´ ë…¹í™”ëœ ë°ì´í„°: {self.data}")  

        name = simpledialog.askstring("ë§¤í¬ë¡œ ì €ì¥", "íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:")
        if name:
            file_path = os.path.join(SAVE_DIR, f"{name}.json")

            if not self.data:
                messagebox.showerror("ì˜¤ë¥˜", "ë…¹í™”ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")
                return

            try:
                with open(file_path, "w") as f:
                    json.dump(self.data, f, indent=4)
                messagebox.showinfo("ì €ì¥ ì™„ë£Œ", f"'{name}.json' íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")
                self.update_file_list()  # ğŸ”¥ íŒŒì¼ ì €ì¥ í›„ ë¦¬ìŠ¤íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            except Exception as e:
                messagebox.showerror("ì €ì¥ ì˜¤ë¥˜", f"íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    def open_macro_selection(self):
        """ ì‹¤í–‰í•  ë§¤í¬ë¡œë¥¼ ì„ íƒí•˜ëŠ” ì°½ ì—´ê¸° """
        self.update_file_list()
        files = [file.replace(".json", "") for file in os.listdir(SAVE_DIR) if file.endswith(".json")]
        if not files:
            messagebox.showwarning("ê²½ê³ ", "ì‹¤í–‰í•  ë§¤í¬ë¡œê°€ ì—†ìŠµë‹ˆë‹¤!")
            return
        
        selection_window = tk.Toplevel(self.root)
        selection_window.title("ë§¤í¬ë¡œ ì„ íƒ")

        listbox = Listbox(selection_window, selectmode=MULTIPLE, height=10)
        listbox.pack(pady=5)
        for file in files:
            listbox.insert(tk.END, file)

        def start_macro():
            selected_indices = listbox.curselection()
            selected_files = [listbox.get(i) for i in selected_indices]
            selection_window.destroy()
            self.play_macro(selected_files)

        tk.Button(selection_window, text="í™•ì¸", command=start_macro).pack(pady=5)

    def on_click(self, x, y, button, pressed):
        """ ë§ˆìš°ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ê¸°ë¡ """
        if self.recording and pressed:
            event = {
                "type": "click",
                "time": time.time() - self.start_time,
                "position": (x, y),
                "button": "left" if button == mouse.Button.left else "right"
            }
            self.data.append(event)

    def on_key_press(self, key):
        if key == keyboard.Key.enter:
            if self.recording:
                self.stop_recording()

if __name__ == "__main__":
    root = tk.Tk()
    app = MacroRecorder(root)
    root.mainloop()
