import time
import json
import os
import threading
import tkinter as tk
from tkinter import simpledialog, messagebox, Listbox, MULTIPLE
from pynput import mouse, keyboard

# ğŸ“‚ ë§¤í¬ë¡œ íŒŒì¼ ì €ì¥ ê²½ë¡œ ì„¤ì •
SAVE_DIR = "macro_files"
os.makedirs(SAVE_DIR, exist_ok=True)
MAX_FILES = 10

def list_macros():
    """ ì €ì¥ëœ ë§¤í¬ë¡œ ëª©ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸° """
    os.makedirs(SAVE_DIR, exist_ok=True)  # í´ë”ê°€ ì‚­ì œë˜ì—ˆì„ ê²½ìš° ì¬ìƒì„±
    return [f.replace(".json", "") for f in os.listdir(SAVE_DIR) if f.endswith(".json")]

class MacroRecorder:
    def __init__(self, root):
        self.root = root
        self.root.title("ë§ˆìš°ìŠ¤ ë§¤í¬ë¡œ í”„ë¡œê·¸ë¨")
        
        self.recording = False
        self.replaying = False
        self.data = []
        self.start_time = None
        self.speed = 1.0

        # UI êµ¬ì„±
        self.record_button = tk.Button(root, text="ğŸ”´ ë…¹í™” ì‹œì‘", command=self.start_recording)
        self.record_button.pack(pady=5)
        
        self.play_button = tk.Button(root, text="â–¶ ì‹¤í–‰", command=self.open_macro_selection)
        self.play_button.pack(pady=5)
        
        self.stop_button = tk.Button(root, text="â¹ ì •ì§€", command=self.stop_macro, state=tk.DISABLED)
        self.stop_button.pack(pady=5)
        
        self.file_listbox = Listbox(root, height=10)
        self.file_listbox.pack(pady=5)
        self.update_file_list()
        
        self.delete_button = tk.Button(root, text="ğŸ—‘ ì‚­ì œ", command=self.delete_selected_macro)
        self.delete_button.pack(pady=5)

        # í‚¤ë³´ë“œ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ (ì—”í„° í‚¤ ê°ì§€)
        self.listener = keyboard.Listener(on_press=self.on_key_press)
        self.listener.start()

    def update_file_list(self):
        """ ì €ì¥ëœ ë§¤í¬ë¡œ ëª©ë¡ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ """
        self.file_listbox.delete(0, tk.END)
        for macro in list_macros():
            self.file_listbox.insert(tk.END, macro)
    
    def delete_selected_macro(self):
        """ ì„ íƒëœ íŒŒì¼ ì‚­ì œ """
        selection = self.file_listbox.curselection()
        if not selection:
            messagebox.showwarning("ê²½ê³ ", "ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.")
            return
        
        for index in selection[::-1]:
            filename = self.file_listbox.get(index)
            os.remove(os.path.join(SAVE_DIR, f"{filename}.json"))
        
        self.update_file_list()
        messagebox.showinfo("ì‚­ì œ ì™„ë£Œ", "ì„ íƒí•œ ë§¤í¬ë¡œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")

    def start_recording(self):
        """ ë…¹í™” ì‹œì‘ (3ì´ˆ ì¹´ìš´íŠ¸ í›„ ì‹¤í–‰) """
        if self.recording:
            return
        self.recording = True
        self.data = []
        self.start_time = None
        
        self.record_button.config(text="âº ë…¹í™” ì¤‘", state=tk.DISABLED)
        self.stop_button.config(state=tk.NORMAL)
        
        def countdown():
            for i in range(3, 0, -1):
                self.record_button.config(text=f"â³ {i}ì´ˆ í›„ ì‹œì‘...")
                time.sleep(1)
            self.record_button.config(text="âº ë…¹í™” ì¤‘")
            self.start_time = time.time()
            self.mouse_listener = mouse.Listener(on_click=self.on_click, on_move=self.on_move)
            self.mouse_listener.start()
        
        threading.Thread(target=countdown, daemon=True).start()
        
    def stop_recording(self):
        """ ë…¹í™” ì¤‘ì§€ ë° íŒŒì¼ ì €ì¥ """
        if not self.recording:
            return
        self.recording = False

        self.record_button.config(text="ğŸ”´ ë…¹í™” ì‹œì‘", state=tk.NORMAL)
        self.stop_button.config(state=tk.DISABLED)

        if hasattr(self, "mouse_listener"):
            self.mouse_listener.stop()
        
        # ğŸ”¥ ë…¹í™”ëœ ë°ì´í„° í™•ì¸ (ë””ë²„ê¹…ìš©)
        print(f"ë…¹í™”ëœ ë°ì´í„°: {self.data}")

        name = simpledialog.askstring("ë§¤í¬ë¡œ ì €ì¥", "íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:")
        if name:
            file_path = os.path.join(SAVE_DIR, f"{name}.json")
            
            # ğŸ”¥ ì €ì¥í•  ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            if not self.data:
                messagebox.showerror("ì˜¤ë¥˜", "ë…¹í™”ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")
                return

            # ğŸ”¥ JSON íŒŒì¼ë¡œ ë°ì´í„° ì €ì¥
            with open(file_path, "w") as f:
                json.dump(self.data, f, indent=4)

            self.update_file_list()
            messagebox.showinfo("ì €ì¥ ì™„ë£Œ", f"'{name}.json' íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!")

    def open_macro_selection(self):
        """ ì‹¤í–‰í•  ë§¤í¬ë¡œë¥¼ ì„ íƒí•˜ëŠ” ì°½ ì—´ê¸° """
        self.update_file_list()  # ìµœì‹  íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
        files = list_macros()
        if not files:
            messagebox.showwarning("ê²½ê³ ", "ì‹¤í–‰í•  ë§¤í¬ë¡œê°€ ì—†ìŠµë‹ˆë‹¤!")
            return
        
        selection_window = tk.Toplevel(self.root)
        selection_window.title("ë§¤í¬ë¡œ ì„ íƒ")

        listbox = Listbox(selection_window, selectmode=MULTIPLE, height=10)
        listbox.pack(pady=5)
        for file in files:
            listbox.insert(tk.END, file)

        def start_macro():
            selected_indices = listbox.curselection()
            selected_files = [listbox.get(i) for i in selected_indices]
            selection_window.destroy()
            self.play_macro(selected_files)

        tk.Button(selection_window, text="í™•ì¸", command=start_macro).pack(pady=5)

    def play_macro(self, selected_files):
        """ ì €ì¥ëœ ë§¤í¬ë¡œ ì‹¤í–‰ """
        if not selected_files:
            return
        
        try:
            speed = simpledialog.askfloat("ë°°ì† ì„¤ì •", "ë°°ì†ì„ ì…ë ¥í•˜ì„¸ìš” (1 ~ 100)", minvalue=1, maxvalue=100)
            if not speed:
                return
            self.speed = speed
        except:
            return

        self.replaying = True
        self.play_button.config(state=tk.DISABLED)

        def replay():
            for filename in selected_files:
                file_path = os.path.join(SAVE_DIR, f"{filename}.json")
                with open(file_path, "r") as f:
                    macro = json.load(f)
                for action in macro:
                    if not self.replaying:
                        break
                    time.sleep(action["time"] / self.speed)
                    if action["type"] == "click":
                        mouse.Controller().position = action["position"]
                        mouse.Controller().click(mouse.Button.left if action["button"] == "left" else mouse.Button.right)

            self.replaying = False
            self.play_button.config(state=tk.NORMAL)

        threading.Thread(target=replay, daemon=True).start()

    def stop_macro(self):
        """ ë§¤í¬ë¡œ ì‹¤í–‰ ì¤‘ì§€ """
        self.replaying = False

    def on_click(self, x, y, button, pressed):
        if self.recording and pressed:
            self.data.append({
                "type": "click",
                "time": time.time() - self.start_time,
                "position": (x, y),
                "button": "left" if button == mouse.Button.left else "right"
            })

    def on_key_press(self, key):
        if key == keyboard.Key.enter:
            if self.recording:
                self.stop_recording()
            elif self.replaying:
                self.stop_macro()

if __name__ == "__main__":
    root = tk.Tk()
    app = MacroRecorder(root)
    root.mainloop()
